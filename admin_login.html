<!DOCTYPE html>
<html lang="en">
  <head>
    <!-- Meta tags, styles, and other imports -->
    <meta charset="UTF-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <link rel="stylesheet" href="" />
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/css/bootstrap.min.css"
      rel="stylesheet"
      integrity="sha384-GLhlTQ8iRABdZLl6O3oVMWSktQOp6b7In1Zl3/Jr59b6EGGoI1aFkw7cmDA6j6gD"
      crossorigin="anonymous"
    />
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.3.0/css/all.min.css"
      integrity="sha512-SzlrxWUlpfuzQ+pcUCosxcglQRNAq/DZjVsC0lE40xsADsfeQoEypE+enwcOiGjk/bSuGGKHEyjSoQ1zVisanQ=="
      crossorigin="anonymous"
      referrerpolicy="no-referrer"
    />
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/animate.css/4.1.1/animate.min.css"
    />
    <title>Bus Tracking System-Admin Login</title>

    <style>
      * {
        font-family: "Inter", sans-serif;
      }

      .h-font {
        font-family: "Poppins", sans-serif;
      }

      .login-form {
        position: absolute;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        width: 400px;
      }
    </style>
  </head>

  <body>
    <section>
      <div
        class="login-form text-center rounded bg-white shadow overflow-hidden"
      >
        <form id="loginForm" method="post" action="">
          <h4 class="bg-primary text-white py-3">Login Page</h4>
          <div class="p-4">
            <div class="mb-3">
              <label class="form-label">Role</label>
              <select class="form-select" id="role" required>
                <option value="">Select Role</option>
                <option value="admin">Admin</option>
                <option value="student">Student</option>
              </select>
            </div>
            <div class="mb-3">
              <label class="form-label">Email</label>
              <input
                type="email"
                required
                name="email"
                id="email"
                class="form-control shadow-none"
              />
            </div>
            <div class="mb-4">
              <label class="form-label">Password</label>
              <input
                type="password"
                required
                name="password"
                id="password"
                class="form-control shadow-none"
              />
            </div>
            <button
              name="login"
              type="submit"
              class="btn text-white bg-primary shadow-none"
            >
              Login
            </button>
          </div>
        </form>
      </div>
    </section>

    <script type="module">
      // Import Firebase modules
      import { initializeApp } from "https://www.gstatic.com/firebasejs/10.8.1/firebase-app.js";
      import {
        getDatabase,
        ref,
        get,
        child,
      } from "https://www.gstatic.com/firebasejs/10.8.1/firebase-database.js";
      import {
        getAuth,
        signInWithEmailAndPassword,
      } from "https://www.gstatic.com/firebasejs/10.8.1/firebase-auth.js";

      // Firebase configuration
      const firebaseConfig = {
        apiKey: "AIzaSyCKYdEtZmhE_GLfR1LsIKf75e_YbQjDvSs",
        authDomain: "computing-project-f65ec.firebaseapp.com",
        databaseURL:
          "https://computing-project-f65ec-default-rtdb.firebaseio.com",
        projectId: "computing-project-f65ec",
        storageBucket: "computing-project-f65ec.appspot.com",
        messagingSenderId: "126022707574",
        appId: "1:126022707574:web:795b761b783e0dfa62f257",
        measurementId: "G-XG2N2HVR9M",
      };

      // Initialize Firebase
      const firebaseApp = initializeApp(firebaseConfig);
      const database = getDatabase(firebaseApp);
      const auth = getAuth(firebaseApp);

      const loginForm = document.getElementById("loginForm");

      loginForm.addEventListener("submit", async (e) => {
        e.preventDefault();
        const role = document.getElementById("role").value;
        const email = document.getElementById("email").value;
        const password = document.getElementById("password").value;

        if (role === "admin") {
          signInWithEmailAndPassword(auth, email, password)
            .then((userCredential) => {
              // Redirect to admin page
              window.location.href = "admin_page.html";
            })
            .catch((error) => {
              const errorCode = error.code;
              const errorMessage = error.message;
              console.error(errorCode, errorMessage);
              alert("Incorrect email or password. Please try again.");
            });
        } else if (role === "student") {
          // Check if student email exists in database
          const studentsRef = ref(database, "students");
          const snapshot = await get(studentsRef);
          if (snapshot.exists()) {
            const students = snapshot.val();
            // Loop through students to find a match
            let studentExists = false;
            Object.keys(students).forEach((studentId) => {
              const student = students[studentId];
              if (student.email === email && student.password === password) {
                studentExists = true;
                // Redirect to student page
                window.location.href = "index.html";
              }
            });
            if (!studentExists) {
              alert(
                "Student with this email does not exist or incorrect password."
              );
            }
          } else {
            alert("No students registered in the database.");
          }
        }
      });
    </script>
  </body>
</html>
