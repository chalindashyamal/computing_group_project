<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Document</title>
  </head>
  <body>
    <!-- Admin Panel -->
    <div class="container mt-5">
      <h2>Add Bus Schedule</h2>
      <form id="scheduleForm">
        <div class="mb-3">
          <label for="busRoute" class="form-label">Bus Route</label>
          <input type="text" class="form-control" id="busRoute" required />
        </div>
        <div class="mb-3">
          <label for="date" class="form-label">Date</label>
          <input type="date" class="form-control" id="date" required />
        </div>
        <div class="mb-3">
          <label for="departureTime" class="form-label">Departure Time</label>
          <input type="time" class="form-control" id="departureTime" required />
        </div>
        <button type="submit" class="btn btn-primary">Add Schedule</button>
      </form>
    </div>

    <!-- User Calendar -->
    <div class="container mt-5">
      <h2>Bus Schedule</h2>
      <div id="calendar"></div>
    </div>

    <script>
      document.addEventListener("DOMContentLoaded", function () {
        const calendarEl = document.getElementById("calendar");
        const calendar = new FullCalendar.Calendar(calendarEl, {
          initialView: "dayGridMonth",
          events: function (fetchInfo, successCallback, failureCallback) {
            // Fetch schedule data from Firebase
            fetch(
              "https://computing-project-f65ec-default-rtdb.firebaseio.com/schedules.json"
            )
              .then((response) => response.json())
              .then((data) => {
                const events = [];
                // Iterate over each schedule entry and format it for FullCalendar
                Object.keys(data).forEach((key) => {
                  const schedule = data[key];
                  const event = {
                    title: schedule.busRoute,
                    start: schedule.date + "T" + schedule.departureTime,
                    allDay: false, // Adjust based on your requirements
                  };
                  events.push(event);
                });
                successCallback(groupEventsByDate(events)); // Provide the events to FullCalendar, grouped by date
              })
              .catch((error) => {
                console.error("Error fetching schedule data:", error);
                failureCallback(error);
              });
          },
        });
        calendar.render();
      });

      // Function to group events by date
      function groupEventsByDate(events) {
        const eventsByDate = {};
        events.forEach((event) => {
          const date = event.start.substring(0, 10); // Extract the date part
          if (eventsByDate[date]) {
            eventsByDate[date].push(event);
          } else {
            eventsByDate[date] = [event];
          }
        });
        const groupedEvents = [];
        for (const date in eventsByDate) {
          groupedEvents.push(...eventsByDate[date]);
        }
        return groupedEvents;
      }
    </script>

    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/css/bootstrap.min.css"
      rel="stylesheet"
    />
    <link
      href="https://cdn.jsdelivr.net/npm/fullcalendar@5.11.3/main.min.css"
      rel="stylesheet"
    />

    <script src="https://cdn.jsdelivr.net/npm/fullcalendar@5.11.3/main.min.js"></script>
    <script type="module">
      import { initializeApp } from "https://www.gstatic.com/firebasejs/10.8.1/firebase-app.js";
      import {
        getDatabase,
        ref,
        push,
        set,
      } from "https://www.gstatic.com/firebasejs/10.8.1/firebase-database.js";

      // Firebase configuration
      const firebaseConfig = {
        apiKey: "AIzaSyCKYdEtZmhE_GLfR1LsIKf75e_YbQjDvSs",
        authDomain: "computing-project-f65ec.firebaseapp.com",
        databaseURL:
          "https://computing-project-f65ec-default-rtdb.firebaseio.com",
        projectId: "computing-project-f65ec",
        storageBucket: "computing-project-f65ec.appspot.com",
        messagingSenderId: "126022707574",
        appId: "1:126022707574:web:795b761b783e0dfa62f257",
        measurementId: "G-XG2N2HVR9M",
      };

      const firebaseApp = initializeApp(firebaseConfig);
      const database = getDatabase(firebaseApp);

      const scheduleForm = document.getElementById("scheduleForm");

      scheduleForm.addEventListener("submit", function (event) {
        event.preventDefault(); // Prevent default form submission

        // Get form values
        const busRoute = document.getElementById("busRoute").value;
        const date = document.getElementById("date").value;
        const departureTime = document.getElementById("departureTime").value;

        // Reference to "schedules" table in the database
        const schedulesRef = ref(database, "schedules");

        // Push the new schedule data to the database
        push(schedulesRef, {
          busRoute: busRoute,
          date: date,
          departureTime: departureTime,
        })
          .then(() => {
            alert("Schedule added successfully");
            // Clear the form after successful submission
            scheduleForm.reset();
          })
          .catch((error) => {
            alert("Error adding schedule: " + error.message);
            console.error("Error adding schedule: ", error);
          });
      });
    </script>
  </body>
</html>
